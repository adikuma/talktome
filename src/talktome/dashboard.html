<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>talktome</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #000;
  --surface: #080808;
  --border: #1a1a1a;
  --border-light: #222;
  --white: #fff;
  --gray-1: #e5e5e5;
  --gray-2: #999;
  --gray-3: #666;
  --gray-4: #444;
  --gray-5: #2a2a2a;
  --font: 'JetBrains Mono', monospace;
}

html { font-size: 13px; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--gray-1);
  min-height: 100vh;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 24px;
}

header {
  padding: 28px 0 20px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.brand {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--white);
  letter-spacing: -0.02em;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.health {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.7rem;
  color: var(--gray-3);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.health-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--gray-4);
  transition: background 0.3s;
}

.health-dot.ok {
  background: var(--white);
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
}

.health-dot.err { background: #666; }

.poll-bar {
  width: 32px;
  height: 1px;
  background: var(--gray-5);
  overflow: hidden;
}

.poll-fill {
  height: 100%;
  background: var(--gray-3);
  width: 0%;
  transition: width 0.1s linear;
}

.grid {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 24px;
}

@media (max-width: 768px) {
  .grid { grid-template-columns: 1fr; }
}

.section-label {
  font-size: 0.65rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--gray-3);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.section-label .count {
  color: var(--gray-4);
  font-variant-numeric: tabular-nums;
}

.agents {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.agent {
  padding: 10px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  transition: border-color 0.2s;
}

.agent:hover { border-color: var(--border-light); }

.agent-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.agent-name {
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--white);
  display: flex;
  align-items: center;
  gap: 7px;
}

.agent-pip {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--white);
  opacity: 0.6;
}

.agent-pip.active { opacity: 1; }

.agent-mail {
  font-size: 0.7rem;
  color: var(--gray-3);
  font-variant-numeric: tabular-nums;
}

.agent-mail.waiting { color: var(--white); }

.agent-path {
  font-size: 0.65rem;
  color: var(--gray-4);
  margin-top: 4px;
}

.empty-state {
  padding: 32px 12px;
  text-align: center;
  color: var(--gray-4);
  font-size: 0.75rem;
}

.messages {
  display: flex;
  flex-direction: column;
  gap: 1px;
  max-height: calc(100vh - 180px);
  overflow-y: auto;
}

.messages::-webkit-scrollbar { width: 3px; }
.messages::-webkit-scrollbar-track { background: transparent; }
.messages::-webkit-scrollbar-thumb { background: var(--gray-5); border-radius: 1px; }

.msg {
  padding: 10px 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
}

.msg-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  font-size: 0.75rem;
}

.msg-from {
  color: var(--white);
  font-weight: 600;
}

.msg-arrow {
  color: var(--gray-4);
}

.msg-to {
  color: var(--white);
  font-weight: 600;
}

.msg-time {
  color: var(--gray-4);
  margin-left: auto;
  font-size: 0.65rem;
  font-variant-numeric: tabular-nums;
}

.msg-body {
  color: var(--gray-2);
  font-size: 0.8rem;
  line-height: 1.5;
  word-break: break-word;
}

.event {
  padding: 6px 14px;
  font-size: 0.7rem;
  color: var(--gray-4);
}

.event strong {
  color: var(--gray-3);
  font-weight: 500;
}

@keyframes slide-in {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

.new-item {
  animation: slide-in 0.25s ease-out;
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="brand">talktome</div>
    <div class="header-right">
      <div class="health">
        <div class="health-dot" id="health-dot"></div>
        <span id="health-label">--</span>
      </div>
      <div class="poll-bar">
        <div class="poll-fill" id="poll-fill"></div>
      </div>
    </div>
  </header>

  <div class="grid">
    <div>
      <div class="section-label">
        agents
        <span class="count" id="agent-count">0</span>
      </div>
      <div class="agents" id="agents"></div>
    </div>

    <div>
      <div class="section-label">
        messages
        <span class="count" id="msg-count">0</span>
      </div>
      <div class="messages" id="messages"></div>
    </div>
  </div>
</div>

<script>
const POLL = 3000;
let pollStart = Date.now();
let lastActivityLen = 0;
let lastAgentJSON = '';

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function timeStr(ts) {
  const d = new Date(ts * 1000);
  return String(d.getHours()).padStart(2,'0') + ':' +
         String(d.getMinutes()).padStart(2,'0') + ':' +
         String(d.getSeconds()).padStart(2,'0');
}

function ago(ts) {
  const d = Math.floor(Date.now() / 1000 - ts);
  if (d < 5) return 'now';
  if (d < 60) return d + 's';
  if (d < 3600) return Math.floor(d / 60) + 'm';
  return Math.floor(d / 3600) + 'h';
}

async function get(url) {
  try {
    const r = await fetch(url);
    if (!r.ok) throw 0;
    return await r.json();
  } catch { return null; }
}

async function pollHealth() {
  const d = await get('/health');
  const dot = document.getElementById('health-dot');
  const label = document.getElementById('health-label');
  if (d && d.status === 'ok') {
    dot.className = 'health-dot ok';
    label.textContent = 'live';
  } else {
    dot.className = 'health-dot err';
    label.textContent = 'offline';
  }
}

async function pollAgents() {
  const data = await get('/agents');
  const el = document.getElementById('agents');
  const countEl = document.getElementById('agent-count');

  if (!data || data.length === 0) {
    if (lastAgentJSON !== '[]') {
      el.innerHTML = '<div class="empty-state">no agents connected</div>';
      countEl.textContent = '0';
      lastAgentJSON = '[]';
    }
    return;
  }

  const json = JSON.stringify(data);
  if (json === lastAgentJSON) return;
  lastAgentJSON = json;

  countEl.textContent = data.length;
  el.innerHTML = data.map(a => `
    <div class="agent">
      <div class="agent-row">
        <div class="agent-name">
          <div class="agent-pip ${a.status === 'active' ? 'active' : ''}"></div>
          ${esc(a.name)}
        </div>
        <div class="agent-mail ${a.mailbox_count > 0 ? 'waiting' : ''}">${a.mailbox_count}</div>
      </div>
      <div class="agent-path">${esc(a.path)}</div>
    </div>
  `).join('');
}

async function pollActivity() {
  const data = await get('/activity');
  const el = document.getElementById('messages');
  const countEl = document.getElementById('msg-count');

  if (!data || data.length === 0) {
    if (lastActivityLen === 0) {
      el.innerHTML = '<div class="empty-state">no messages yet</div>';
      countEl.textContent = '0';
    }
    return;
  }

  if (data.length === lastActivityLen) return;

  // only render new items
  const newItems = data.slice(lastActivityLen);
  const isFirst = lastActivityLen === 0;
  lastActivityLen = data.length;

  if (isFirst) el.innerHTML = '';

  const msgCount = data.filter(d => d.event === 'message').length;
  countEl.textContent = msgCount;

  for (const item of newItems) {
    const div = document.createElement('div');
    div.className = isFirst ? '' : 'new-item';

    if (item.event === 'message') {
      div.className += ' msg';
      div.innerHTML = `
        <div class="msg-header">
          <span class="msg-from">${esc(item.sender)}</span>
          <span class="msg-arrow">-></span>
          <span class="msg-to">${esc(item.peer)}</span>
          <span class="msg-time">${ago(item.timestamp)}</span>
        </div>
        <div class="msg-body">${esc(item.content || '')}</div>
      `;
    } else if (item.event === 'register') {
      div.className += ' event';
      div.innerHTML = `<strong>${esc(item.agent)}</strong> connected`;
    }

    el.prepend(div);
  }
}

function tickBar() {
  const pct = Math.min(((Date.now() - pollStart) / POLL) * 100, 100);
  document.getElementById('poll-fill').style.width = pct + '%';
  requestAnimationFrame(tickBar);
}

async function tick() {
  pollStart = Date.now();
  await Promise.all([pollHealth(), pollAgents(), pollActivity()]);
}

tickBar();
tick();
setInterval(tick, POLL);
</script>

</body>
</html>
