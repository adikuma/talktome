<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>talktome</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,300;1,400&display=swap");

            *,
            *::before,
            *::after {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg: #000;
                --white: #fff;
                --t1: rgba(255, 255, 255, 0.92);
                --t2: rgba(255, 255, 255, 0.55);
                --t3: rgba(255, 255, 255, 0.28);
                --t4: rgba(255, 255, 255, 0.12);
                --t5: rgba(255, 255, 255, 0.06);
                --t6: rgba(255, 255, 255, 0.03);
                --font: "JetBrains Mono", monospace;
                --green: #34d399;
                --yellow: #fbbf24;
                --red: #f87171;
                --blue: #60a5fa;
            }

            html {
                font-size: 15px;
            }

            body {
                font-family: var(--font);
                background: var(--bg);
                color: var(--t1);
                min-height: 100vh;
                -webkit-font-smoothing: antialiased;
                padding-bottom: 80px;
            }

            ::-webkit-scrollbar {
                width: 0;
            }

            .shell {
                max-width: 1280px;
                margin: 0 auto;
                padding: 0 56px;
            }

            /* header */
            .head {
                padding: 52px 0 0;
                margin-bottom: 64px;
                display: flex;
                align-items: flex-end;
                justify-content: space-between;
            }

            .logo {
                font-size: 1.2rem;
                font-weight: 300;
                color: var(--t1);
                letter-spacing: 0.08em;
                text-transform: lowercase;
            }

            .status {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .status-text {
                font-size: 0.6875rem;
                font-weight: 400;
                letter-spacing: 0.14em;
                text-transform: uppercase;
                color: var(--t3);
                transition: color 0.6s ease;
            }

            .status-text.on {
                color: var(--green);
            }

            .tick-bar {
                width: 40px;
                height: 1px;
                background: var(--t5);
                overflow: hidden;
            }

            .tick-fill {
                height: 100%;
                width: 0%;
                background: var(--t3);
            }

            /* layout */
            .layout {
                display: grid;
                grid-template-columns: 280px 1fr 320px;
                gap: 60px;
            }

            @media (max-width: 1100px) {
                .layout {
                    grid-template-columns: 280px 1fr;
                    gap: 40px;
                }
                .col-tasks {
                    grid-column: 1 / -1;
                }
            }

            @media (max-width: 860px) {
                .shell {
                    padding: 0 28px;
                }
                .layout {
                    grid-template-columns: 1fr;
                    gap: 56px;
                }
            }

            /* labels */
            .label {
                font-size: 0.625rem;
                font-weight: 500;
                letter-spacing: 0.2em;
                text-transform: uppercase;
                color: var(--t3);
                margin-bottom: 32px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .label-num {
                font-weight: 300;
                color: var(--t4);
                font-variant-numeric: tabular-nums;
            }

            /* agents */
            .agent {
                padding: 20px 0;
                border-bottom: 1px solid var(--t5);
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                gap: 16px;
            }

            .agent:first-child {
                padding-top: 0;
            }
            .agent:last-child {
                border-bottom: none;
            }

            .agent-info {
                min-width: 0;
                flex: 1;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .agent-dot {
                width: 4px;
                height: 4px;
                border-radius: 50%;
                background: var(--t3);
                flex-shrink: 0;
            }

            .agent-meta {
                min-width: 0;
                flex: 1;
            }

            .agent-name {
                font-size: 0.9375rem;
                font-weight: 500;
                color: var(--t1);
                margin-bottom: 4px;
            }

            .agent-path {
                font-size: 0.6875rem;
                font-weight: 300;
                color: var(--t4);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .agent-badge {
                font-size: 0.75rem;
                font-weight: 400;
                color: var(--t4);
                font-variant-numeric: tabular-nums;
                flex-shrink: 0;
                min-width: 20px;
                text-align: right;
            }

            .agent-badge.active {
                color: var(--t1);
            }

            /* feed */
            .feed {
                display: flex;
                flex-direction: column;
                gap: 2px;
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }

            .msg {
                padding: 24px 28px;
                background: var(--t6);
                border-radius: 6px;
            }

            .msg-meta {
                margin-bottom: 16px;
                display: grid;
                grid-template-columns: 32px 1fr auto;
                gap: 2px 10px;
                align-items: baseline;
            }

            .msg-label {
                font-size: 0.625rem;
                font-weight: 400;
                letter-spacing: 0.06em;
                color: var(--t4);
            }

            .msg-name {
                font-size: 0.8125rem;
                font-weight: 500;
                color: var(--t1);
            }

            .msg-ts {
                font-size: 0.625rem;
                font-weight: 300;
                color: var(--t4);
                font-variant-numeric: tabular-nums;
                grid-row: 1 / 3;
                grid-column: 3;
                align-self: start;
                padding-top: 2px;
            }

            .msg-body {
                font-size: 0.875rem;
                font-weight: 300;
                line-height: 1.7;
                color: var(--t2);
                word-break: break-word;
            }

            /* tasks */
            .task {
                padding: 16px 0;
                border-bottom: 1px solid var(--t5);
            }

            .task:first-child {
                padding-top: 0;
            }
            .task:last-child {
                border-bottom: none;
            }

            .task-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 8px;
            }

            .task-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .task-dot.pending {
                background: var(--t3);
            }
            .task-dot.running {
                background: var(--yellow);
            }
            .task-dot.done {
                background: var(--green);
            }
            .task-dot.failed {
                background: var(--red);
            }

            .task-agent {
                font-size: 0.75rem;
                font-weight: 500;
                color: var(--t2);
            }

            .task-id {
                font-size: 0.625rem;
                font-weight: 300;
                color: var(--t4);
                margin-left: auto;
                font-variant-numeric: tabular-nums;
            }

            .task-desc {
                font-size: 0.8125rem;
                font-weight: 300;
                color: var(--t2);
                line-height: 1.5;
                padding-left: 16px;
            }

            .task-result {
                font-size: 0.6875rem;
                font-weight: 300;
                color: var(--t4);
                padding-left: 16px;
                margin-top: 6px;
            }

            .task-time {
                font-size: 0.5625rem;
                font-weight: 300;
                color: var(--t4);
                padding-left: 16px;
                margin-top: 4px;
                font-variant-numeric: tabular-nums;
            }

            /* command bar */
            .cmdbar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.95);
                border-top: 1px solid var(--t5);
                padding: 16px 56px;
                backdrop-filter: blur(12px);
                z-index: 100;
            }

            .cmdbar-inner {
                max-width: 1280px;
                margin: 0 auto;
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .cmdbar-prompt {
                font-size: 0.75rem;
                font-weight: 400;
                color: var(--t3);
                flex-shrink: 0;
            }

            .cmdbar-select {
                background: transparent;
                border: 1px solid var(--t5);
                color: var(--t2);
                font-family: var(--font);
                font-size: 0.75rem;
                font-weight: 300;
                padding: 8px 12px;
                border-radius: 4px;
                outline: none;
                min-width: 120px;
                cursor: pointer;
            }

            .cmdbar-select:focus {
                border-color: var(--t3);
            }

            .cmdbar-select option {
                background: #111;
                color: var(--t1);
            }

            .cmdbar-input {
                flex: 1;
                background: transparent;
                border: 1px solid var(--t5);
                color: var(--t1);
                font-family: var(--font);
                font-size: 0.8125rem;
                font-weight: 300;
                padding: 8px 16px;
                border-radius: 4px;
                outline: none;
            }

            .cmdbar-input::placeholder {
                color: var(--t4);
            }

            .cmdbar-input:focus {
                border-color: var(--t3);
            }

            .cmdbar-send {
                background: transparent;
                border: 1px solid var(--t5);
                color: var(--t3);
                font-family: var(--font);
                font-size: 0.6875rem;
                font-weight: 400;
                letter-spacing: 0.1em;
                text-transform: uppercase;
                padding: 8px 20px;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .cmdbar-send:hover {
                border-color: var(--t2);
                color: var(--t1);
            }

            /* empty */
            .empty {
                padding: 40px 0;
                text-align: center;
                font-size: 0.75rem;
                font-weight: 300;
                color: var(--t4);
            }

            /* animation */
            @keyframes enter {
                from {
                    opacity: 0;
                    transform: translateY(-4px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .anim {
                animation: enter 0.25s ease-out;
            }
        </style>
    </head>
    <body>
        <div class="shell">
            <div class="head">
                <div class="logo">talktome</div>
                <div class="status">
                    <span class="status-text" id="st">--</span>
                    <div class="tick-bar">
                        <div class="tick-fill" id="tf"></div>
                    </div>
                </div>
            </div>

            <div class="layout">
                <div>
                    <div class="label">
                        <span>agents</span>
                        <span class="label-num" id="ac">0</span>
                    </div>
                    <div class="agents" id="ag"></div>
                </div>
                <div>
                    <div class="label">
                        <span>activity</span>
                        <span class="label-num" id="mc">0</span>
                    </div>
                    <div class="feed" id="fd"></div>
                </div>
                <div class="col-tasks">
                    <div class="label">
                        <span>tasks</span>
                        <span class="label-num" id="tc">0</span>
                    </div>
                    <div id="tl"></div>
                </div>
            </div>
        </div>

        <div class="cmdbar">
            <div class="cmdbar-inner">
                <span class="cmdbar-prompt">&gt;</span>
                <select class="cmdbar-select" id="cmd-agent">
                    <option value="">agent</option>
                </select>
                <input
                    class="cmdbar-input"
                    id="cmd-input"
                    type="text"
                    placeholder="assign a task..."
                    autocomplete="off"
                />
                <button class="cmdbar-send" id="cmd-send">send</button>
            </div>
        </div>

        <script>
            (function () {
                var POLL = 3000,
                    ps = Date.now(),
                    aLen = 0,
                    aJSON = "",
                    tJSON = "",
                    agentNames = [];

                function txt(el, s) {
                    el.textContent = s || "";
                }
                function mk(t, c) {
                    var e = document.createElement(t);
                    if (c) e.className = c;
                    return e;
                }

                function ago(ts) {
                    var s = Math.floor(Date.now() / 1000 - ts);
                    if (s < 5) return "now";
                    if (s < 60) return s + "s";
                    if (s < 3600) return Math.floor(s / 60) + "m";
                    return Math.floor(s / 3600) + "h";
                }

                function get(u) {
                    return fetch(u)
                        .then(function (r) {
                            if (!r.ok) throw 0;
                            return r.json();
                        })
                        .catch(function () {
                            return null;
                        });
                }

                function health() {
                    return get("/health").then(function (d) {
                        var st = document.getElementById("st");
                        if (d && d.status === "ok") {
                            st.className = "status-text on";
                            txt(st, "live");
                        } else {
                            st.className = "status-text";
                            txt(st, "offline");
                        }
                    });
                }

                function agents() {
                    return get("/agents").then(function (data) {
                        var el = document.getElementById("ag"),
                            ct = document.getElementById("ac");
                        if (!data || !data.length) {
                            if (aJSON !== "[]") {
                                el.innerHTML = "";
                                var em = mk("div", "empty");
                                txt(em, "no agents");
                                el.appendChild(em);
                                txt(ct, "0");
                                aJSON = "[]";
                                agentNames = [];
                                updateAgentSelect();
                            }
                            return;
                        }
                        var j = JSON.stringify(data);
                        if (j === aJSON) return;
                        aJSON = j;
                        txt(ct, String(data.length));
                        el.innerHTML = "";
                        agentNames = [];
                        for (var i = 0; i < data.length; i++) {
                            var a = data[i];
                            agentNames.push(a.name);
                            var card = mk("div", "agent");
                            var info = mk("div", "agent-info");
                            var dot = mk("div", "agent-dot");
                            var meta = mk("div", "agent-meta");
                            var nm = mk("div", "agent-name");
                            txt(nm, a.name);
                            var pt = mk("div", "agent-path");
                            txt(pt, a.path);
                            meta.appendChild(nm);
                            meta.appendChild(pt);
                            info.appendChild(dot);
                            info.appendChild(meta);
                            var bd = mk(
                                "div",
                                "agent-badge" +
                                    (a.mailbox_count > 0 ? " active" : ""),
                            );
                            txt(
                                bd,
                                a.mailbox_count > 0
                                    ? String(a.mailbox_count)
                                    : "",
                            );
                            card.appendChild(info);
                            card.appendChild(bd);
                            el.appendChild(card);
                        }
                        updateAgentSelect();
                    });
                }

                function updateAgentSelect() {
                    var sel = document.getElementById("cmd-agent");
                    var cur = sel.value;
                    sel.innerHTML = "";
                    var def = mk("option");
                    def.value = "";
                    txt(def, "agent");
                    sel.appendChild(def);
                    for (var i = 0; i < agentNames.length; i++) {
                        var opt = mk("option");
                        opt.value = agentNames[i];
                        txt(opt, agentNames[i]);
                        sel.appendChild(opt);
                    }
                    if (cur && agentNames.indexOf(cur) >= 0) sel.value = cur;
                }

                function activity() {
                    return get("/activity").then(function (data) {
                        var el = document.getElementById("fd"),
                            ct = document.getElementById("mc");
                        if (!data || !data.length) {
                            if (!aLen) {
                                el.innerHTML = "";
                                var em = mk("div", "empty");
                                txt(em, "no activity");
                                el.appendChild(em);
                            }
                            return;
                        }
                        if (data.length === aLen) return;
                        var nw = data.slice(aLen),
                            first = !aLen;
                        aLen = data.length;
                        if (first) el.innerHTML = "";
                        txt(ct, String(data.length));
                        for (var i = 0; i < nw.length; i++) {
                            var it = nw[i];
                            var d = mk("div", "msg" + (first ? "" : " anim"));
                            var mt = mk("div", "msg-meta");

                            if (it.event === "message") {
                                var fl = mk("span", "msg-label");
                                txt(fl, "From");
                                var fn = mk("span", "msg-name");
                                txt(fn, it.sender);
                                var tl = mk("span", "msg-label");
                                txt(tl, "To");
                                var tn = mk("span", "msg-name");
                                txt(tn, it.peer);
                                var ts = mk("span", "msg-ts");
                                txt(ts, ago(it.timestamp));
                                mt.appendChild(fl);
                                mt.appendChild(fn);
                                mt.appendChild(ts);
                                mt.appendChild(tl);
                                mt.appendChild(tn);
                                var bd = mk("div", "msg-body");
                                txt(bd, it.content || "");
                                d.appendChild(mt);
                                d.appendChild(bd);
                            } else if (
                                it.event === "task_created" ||
                                it.event === "task_updated"
                            ) {
                                var el2 = mk("span", "msg-label");
                                txt(el2, it.event === "task_created" ? "Task" : "Update");
                                var en = mk("span", "msg-name");
                                txt(en, it.agent || it.task_id || "");
                                var ts2 = mk("span", "msg-ts");
                                txt(ts2, ago(it.timestamp));
                                mt.appendChild(el2);
                                mt.appendChild(en);
                                mt.appendChild(ts2);
                                if (it.event === "task_created") {
                                    var sl = mk("span", "msg-label");
                                    txt(sl, "Desc");
                                    var sn = mk("span", "msg-name");
                                    txt(sn, it.description || "");
                                    mt.appendChild(sl);
                                    mt.appendChild(sn);
                                } else {
                                    var sl2 = mk("span", "msg-label");
                                    txt(sl2, "Status");
                                    var sn2 = mk("span", "msg-name");
                                    txt(sn2, it.status || "");
                                    mt.appendChild(sl2);
                                    mt.appendChild(sn2);
                                }
                                d.appendChild(mt);
                            } else if (it.event === "register") {
                                var rl = mk("span", "msg-label");
                                txt(rl, "Join");
                                var rn = mk("span", "msg-name");
                                txt(rn, it.agent || "");
                                var rts = mk("span", "msg-ts");
                                txt(rts, ago(it.timestamp));
                                mt.appendChild(rl);
                                mt.appendChild(rn);
                                mt.appendChild(rts);
                                var rl2 = mk("span", "msg-label");
                                txt(rl2, "Path");
                                var rp = mk("span", "msg-name");
                                txt(rp, it.path || "");
                                mt.appendChild(rl2);
                                mt.appendChild(rp);
                                d.appendChild(mt);
                            } else {
                                continue;
                            }
                            el.prepend(d);
                        }
                    });
                }

                function tasks() {
                    return get("/tasks").then(function (data) {
                        var el = document.getElementById("tl"),
                            ct = document.getElementById("tc");
                        if (!data) return;
                        var j = JSON.stringify(data);
                        if (j === tJSON) return;
                        tJSON = j;
                        txt(ct, String(data.length));
                        el.innerHTML = "";
                        if (!data.length) {
                            var em = mk("div", "empty");
                            txt(em, "no tasks");
                            el.appendChild(em);
                            return;
                        }
                        for (var i = 0; i < data.length; i++) {
                            var t = data[i];
                            var card = mk("div", "task");
                            var hdr = mk("div", "task-header");
                            var dot = mk("div", "task-dot " + t.status);
                            var agent = mk("span", "task-agent");
                            txt(agent, t.agent);
                            var tid = mk("span", "task-id");
                            txt(tid, t.id);
                            hdr.appendChild(dot);
                            hdr.appendChild(agent);
                            hdr.appendChild(tid);
                            card.appendChild(hdr);
                            var desc = mk("div", "task-desc");
                            txt(desc, t.description);
                            card.appendChild(desc);
                            if (t.result) {
                                var res = mk("div", "task-result");
                                txt(res, t.result);
                                card.appendChild(res);
                            }
                            var tm = mk("div", "task-time");
                            txt(tm, ago(t.created_at));
                            card.appendChild(tm);
                            el.appendChild(card);
                        }
                    });
                }

                // command bar
                function sendTask() {
                    var sel = document.getElementById("cmd-agent");
                    var inp = document.getElementById("cmd-input");
                    var agent = sel.value;
                    var desc = inp.value.trim();
                    if (!agent || !desc) return;
                    fetch("/task", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            agent: agent,
                            description: desc,
                        }),
                    })
                        .then(function () {
                            inp.value = "";
                            tick();
                        })
                        .catch(function () {});
                }

                document
                    .getElementById("cmd-send")
                    .addEventListener("click", sendTask);
                document
                    .getElementById("cmd-input")
                    .addEventListener("keydown", function (e) {
                        if (e.key === "Enter") sendTask();
                    });

                function bar() {
                    var p = Math.min(((Date.now() - ps) / POLL) * 100, 100);
                    document.getElementById("tf").style.width = p + "%";
                    requestAnimationFrame(bar);
                }

                function tick() {
                    ps = Date.now();
                    Promise.all([health(), agents(), activity(), tasks()]);
                }
                bar();
                tick();
                setInterval(tick, POLL);
            })();
        </script>
    </body>
</html>
