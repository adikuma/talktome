<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>talktome</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap");

            *,
            *::before,
            *::after {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg: #0a0a0a;
                --card: #141414;
                --card-hover: #1a1a1a;
                --white: #fff;
                --t1: rgba(255, 255, 255, 0.9);
                --t2: rgba(255, 255, 255, 0.5);
                --t3: rgba(255, 255, 255, 0.25);
                --t4: rgba(255, 255, 255, 0.1);
                --border: rgba(255, 255, 255, 0.15);
                --green: #00ff88;
                --yellow: #ffcc00;
                --red: #ff3333;
                --blue: #5599ff;
                --font: "JetBrains Mono", monospace;
                --sidebar-w: 240px;
            }

            html {
                font-size: 14px;
            }

            body {
                font-family: var(--font);
                background: var(--bg);
                color: var(--t1);
                min-height: 100vh;
                -webkit-font-smoothing: antialiased;
            }

            ::-webkit-scrollbar {
                width: 4px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: var(--t4);
                border-radius: 2px;
            }

            .shell {
                display: flex;
                height: 100vh;
            }

            /* ── sidebar ── */
            .sidebar {
                width: var(--sidebar-w);
                min-width: var(--sidebar-w);
                border-right: 1px solid var(--border);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                background: var(--bg);
            }

            .sidebar-header {
                padding: 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
                cursor: pointer;
            }

            .sidebar-header:hover {
                background: rgba(255, 255, 255, 0.03);
            }

            .logo {
                font-size: 0.85rem;
                font-weight: 700;
                color: var(--white);
                text-transform: uppercase;
                letter-spacing: 0.15em;
            }

            .health-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: var(--t4);
                transition: background 0.3s;
            }

            .health-dot.on {
                background: var(--green);
                box-shadow: 0 0 6px var(--green);
            }

            .sidebar-scroll {
                flex: 1;
                overflow-y: auto;
                padding: 0;
            }

            .sb-label {
                font-size: 0.55rem;
                font-weight: 700;
                letter-spacing: 0.2em;
                text-transform: uppercase;
                color: var(--t3);
                padding: 16px 16px 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .sb-count {
                color: var(--t3);
            }

            /* agent cards */
            .agent-card {
                padding: 10px 16px;
                cursor: pointer;
                border-bottom: 1px solid var(--t4);
                display: flex;
                align-items: center;
                gap: 10px;
                transition: background 0.15s;
            }

            .agent-card:hover {
                background: rgba(255, 255, 255, 0.04);
            }

            .agent-card.active {
                background: rgba(255, 255, 255, 0.06);
                border-left: 2px solid var(--white);
                padding-left: 14px;
            }

            .agent-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .agent-dot.on {
                background: var(--green);
                box-shadow: 0 0 4px var(--green);
            }

            .agent-dot.off {
                background: var(--t4);
            }

            .agent-info {
                flex: 1;
                min-width: 0;
            }

            .agent-name {
                font-size: 0.8rem;
                font-weight: 500;
                color: var(--t1);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .agent-path {
                font-size: 0.6rem;
                font-weight: 300;
                color: var(--t3);
                margin-top: 1px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .agent-badge {
                font-size: 0.55rem;
                font-weight: 700;
                background: var(--blue);
                color: var(--bg);
                width: 18px;
                height: 18px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            /* activity accordion */
            .activity-section {
                border-top: 1px solid var(--t4);
                margin-top: 4px;
            }

            .activity-header {
                padding: 12px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                user-select: none;
                font-size: 0.7rem;
                font-weight: 700;
                letter-spacing: 0.2em;
                text-transform: uppercase;
                color: var(--t3);
                transition: background 0.15s;
            }

            .activity-header:hover {
                background: rgba(255, 255, 255, 0.04);
            }

            .activity-arrow {
                margin-left: auto;
                font-size: 1rem;
                color: var(--t3);
                transition: transform 0.2s ease;
                display: inline-block;
            }

            .activity-header.open .activity-arrow {
                transform: rotate(180deg);
            }

            .activity-body {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .activity-body.open {
                max-height: 260px;
                overflow-y: auto;
            }

            .activity-item {
                padding: 7px 16px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 0.7rem;
                border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            }

            .activity-tag {
                font-weight: 700;
                letter-spacing: 0.06em;
                text-transform: uppercase;
                width: 42px;
                flex-shrink: 0;
            }

            .activity-tag.join {
                color: var(--green);
            }
            .activity-tag.msg {
                color: var(--blue);
            }
            .activity-tag.task {
                color: var(--yellow);
            }
            .activity-tag.update {
                color: var(--t3);
            }

            .activity-text {
                flex: 1;
                color: var(--t2);
                font-weight: 300;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .activity-time {
                color: var(--t3);
                font-weight: 300;
                flex-shrink: 0;
                font-variant-numeric: tabular-nums;
            }

            /* ── content ── */
            .content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                background: var(--bg);
            }

            .content-header {
                padding: 16px 24px;
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
                display: flex;
                align-items: baseline;
                gap: 10px;
            }

            .content-title {
                font-size: 0.9rem;
                font-weight: 700;
                color: var(--white);
                text-transform: uppercase;
                letter-spacing: 0.1em;
            }

            .content-sub {
                font-size: 0.6rem;
                font-weight: 300;
                color: var(--t3);
                letter-spacing: 0.04em;
            }

            .content-scroll {
                flex: 1;
                overflow-y: auto;
                padding: 20px 24px 100px;
            }

            /* stats row */
            .stats-row {
                display: flex;
                align-items: center;
                gap: 14px;
                padding-bottom: 16px;
                margin-bottom: 16px;
                border-bottom: 1px solid var(--t4);
                font-size: 0.6rem;
                color: var(--t3);
            }

            .stat {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .stat-dot {
                width: 5px;
                height: 5px;
                border-radius: 50%;
            }

            .stat-dot.on {
                background: var(--green);
            }
            .stat-dot.pending {
                background: var(--t3);
            }
            .stat-dot.running {
                background: var(--yellow);
            }
            .stat-dot.done {
                background: var(--green);
            }
            .stat-dot.failed {
                background: var(--red);
            }

            .stat-sep {
                color: var(--t4);
            }

            /* section labels */
            .section-label {
                font-size: 0.55rem;
                font-weight: 700;
                letter-spacing: 0.2em;
                text-transform: uppercase;
                color: var(--t3);
                margin-bottom: 10px;
            }

            /* filter tabs */
            .filter-tabs {
                display: flex;
                gap: 4px;
                margin-bottom: 14px;
            }

            .filter-tab {
                appearance: none;
                -webkit-appearance: none;
                background: transparent;
                border: none;
                border-bottom: 1px solid transparent;
                color: var(--t3);
                font-family: var(--font);
                font-size: 0.55rem;
                font-weight: 500;
                letter-spacing: 0.06em;
                text-transform: uppercase;
                padding: 4px 8px;
                cursor: pointer;
                transition: all 0.15s;
            }


            .filter-tab.active {
                color: var(--white);
                border-bottom-color: var(--white);
                font-weight: 700;
            }

            /* ── task cards ── */
            .task-card {
                background: transparent;
                border-bottom: 1px solid var(--t4);
                padding: 14px 0;
                transition: background 0.15s ease;
            }


            .task-top {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 4px;
            }

            .task-status-badge {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 0.55rem;
                font-weight: 700;
                letter-spacing: 0.1em;
                text-transform: uppercase;
            }

            .task-status-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .task-status-dot.running {
                animation: pulse 1.5s ease-in-out infinite;
            }

            .task-id {
                font-size: 0.5rem;
                color: var(--t3);
                font-variant-numeric: tabular-nums;
            }

            .task-agent {
                font-size: 0.6rem;
                color: var(--t3);
                margin-bottom: 6px;
            }

            .task-desc {
                font-size: 0.85rem;
                color: var(--t1);
                line-height: 1.6;
                margin-bottom: 4px;
            }

            .task-result-block {
                background: transparent;
                border-left: 2px solid var(--t4);
                padding: 6px 0 6px 12px;
                font-size: 0.7rem;
                color: var(--t2);
                line-height: 1.6;
                margin-top: 8px;
                margin-bottom: 4px;
                white-space: pre-wrap;
                word-break: break-word;
                max-height: 120px;
                overflow-y: auto;
            }

            .task-time {
                font-size: 0.5rem;
                color: var(--t3);
                font-variant-numeric: tabular-nums;
                margin-top: 6px;
            }

            /* ── message cards ── */
            .msg-card {
                display: flex;
                gap: 12px;
                background: transparent;
                border-bottom: 1px solid var(--t4);
                padding: 12px 0;
                transition: background 0.15s ease;
            }


            .msg-avatar {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.6rem;
                font-weight: 700;
                color: var(--bg);
                flex-shrink: 0;
                text-transform: uppercase;
            }

            .msg-content {
                flex: 1;
                min-width: 0;
            }

            .msg-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 4px;
            }

            .msg-sender {
                font-size: 0.7rem;
                font-weight: 500;
                color: var(--white);
            }

            .msg-time {
                font-size: 0.5rem;
                color: var(--t3);
                font-variant-numeric: tabular-nums;
            }

            .msg-body {
                font-size: 0.8rem;
                font-weight: 300;
                color: var(--t2);
                line-height: 1.6;
            }

            /* ── command bar ── */
            .cmdbar {
                border-top: 1px solid var(--border);
                padding: 10px 24px;
                flex-shrink: 0;
                background: var(--bg);
            }

            .cmdbar-inner {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .cmdbar-label {
                font-size: 0.55rem;
                font-weight: 500;
                color: var(--t3);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                flex-shrink: 0;
            }

            .cmdbar-select {
                appearance: none;
                -webkit-appearance: none;
                background: var(--card);
                border: 1px solid var(--border);
                color: var(--t2);
                font-family: var(--font);
                font-size: 0.65rem;
                font-weight: 400;
                padding: 6px 24px 6px 8px;
                outline: none;
                min-width: 90px;
                cursor: pointer;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(255,255,255,0.3)'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 8px center;
                transition: border-color 0.15s;
            }

            .cmdbar-select:focus {
                border-color: var(--white);
            }

            .cmdbar-select option {
                background: var(--card);
                color: var(--white);
            }

            .cmdbar-mode {
                display: flex;
                flex-shrink: 0;
            }

            .cmdbar-mode-btn {
                appearance: none;
                -webkit-appearance: none;
                background: var(--card);
                border: 1px solid var(--border);
                color: var(--t3);
                font-family: var(--font);
                font-size: 0.55rem;
                font-weight: 700;
                letter-spacing: 0.1em;
                text-transform: uppercase;
                padding: 6px 10px;
                cursor: pointer;
                transition: all 0.15s;
            }

            .cmdbar-mode-btn:last-child {
                border-left: none;
            }

            .cmdbar-mode-btn.task-active {
                background: var(--yellow);
                color: var(--bg);
                border-color: var(--yellow);
            }

            .cmdbar-mode-btn.msg-active {
                background: var(--blue);
                color: var(--bg);
                border-color: var(--blue);
            }

            .cmdbar-input {
                flex: 1;
                background: var(--card);
                border: 1px solid var(--t4);
                border-radius: 0;
                color: var(--t1);
                font-family: var(--font);
                font-size: 0.8rem;
                font-weight: 300;
                padding: 6px 10px;
                outline: none;
                transition: border-color 0.15s;
            }

            .cmdbar-input:focus {
                border-color: var(--white);
            }

            .cmdbar-input::placeholder {
                color: var(--t3);
            }

            .cmdbar-send {
                appearance: none;
                -webkit-appearance: none;
                border: none;
                font-family: var(--font);
                font-size: 0.55rem;
                font-weight: 700;
                letter-spacing: 0.1em;
                text-transform: uppercase;
                padding: 7px 14px;
                cursor: pointer;
                transition: opacity 0.15s;
            }

            .cmdbar-send:hover {
                opacity: 0.8;
            }

            .cmdbar-send.task-mode {
                background: var(--yellow);
                color: var(--bg);
            }

            .cmdbar-send.msg-mode {
                background: var(--blue);
                color: var(--bg);
            }

            /* ── empty states ── */
            .empty {
                padding: 40px 0;
                text-align: center;
                font-size: 0.75rem;
                font-weight: 300;
                color: var(--t3);
                line-height: 2;
            }

            .empty-hint {
                font-size: 0.6rem;
                color: var(--t4);
            }

            /* ── tasks section spacing ── */
            .tasks-section {
                margin-top: 28px;
            }

            /* ── keyframes ── */
            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.3;
                }
            }
        </style>
    </head>
    <body>
        <div class="shell">
            <div class="sidebar">
                <div class="sidebar-header" id="home-btn">
                    <span class="logo">talktome</span>
                    <div class="health-dot" id="hd"></div>
                </div>
                <div class="sidebar-scroll">
                    <div class="sb-label">
                        <span>agents</span>
                        <span class="sb-count" id="agent-count">0</span>
                    </div>
                    <div id="agent-list"></div>

                    <div class="activity-section">
                        <div class="activity-header" id="activity-toggle">
                            <span>activity</span>
                            <span
                                class="sb-count"
                                id="activity-count"
                            >
                                0
                            </span>
                            <span class="activity-arrow"
                                >&#9662;</span
                            >
                        </div>
                        <div class="activity-body" id="activity-body">
                            <div id="activity-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content">
                <div class="content-header">
                    <div class="content-title" id="content-title">
                        overview
                    </div>
                    <div
                        class="content-sub"
                        id="content-sub"
                    ></div>
                </div>
                <div class="content-scroll" id="content-area"></div>

                <div class="cmdbar">
                    <div class="cmdbar-inner">
                        <span class="cmdbar-label">to:</span>
                        <select class="cmdbar-select" id="cmd-agent">
                            <option value="">agent</option>
                        </select>
                        <div class="cmdbar-mode">
                            <button
                                class="cmdbar-mode-btn task-active"
                                id="mode-task"
                            >
                                task
                            </button>
                            <button
                                class="cmdbar-mode-btn"
                                id="mode-msg"
                            >
                                msg
                            </button>
                        </div>
                        <input
                            class="cmdbar-input"
                            id="cmd-input"
                            type="text"
                            placeholder="assign a task..."
                            autocomplete="off"
                        />
                        <button
                            class="cmdbar-send task-mode"
                            id="cmd-send"
                        >
                            send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            (function () {
                var POLL = 3000;

                var state = {
                    selectedAgent: null,
                    mode: "task",
                    taskFilter: "all",
                    activityOpen: false,
                    agentNames: [],
                    agentPaths: {},
                    agentsJSON: "",
                    activityJSON: "",
                    contentJSON: "",
                    cachedTasks: [],
                    cachedPeek: null,
                };

                function txt(el, s) {
                    el.textContent = s || "";
                }

                function mk(t, c) {
                    var e = document.createElement(t);
                    if (c) e.className = c;
                    return e;
                }

                function ago(ts) {
                    var s = Math.floor(Date.now() / 1000 - ts);
                    if (s < 5) return "now";
                    if (s < 60) return s + "s";
                    if (s < 3600) return Math.floor(s / 60) + "m";
                    if (s < 86400)
                        return Math.floor(s / 3600) + "h";
                    return Math.floor(s / 86400) + "d";
                }

                function get(u) {
                    return fetch(u)
                        .then(function (r) {
                            if (!r.ok) throw 0;
                            return r.json();
                        })
                        .catch(function () {
                            return null;
                        });
                }

                function shortPath(p) {
                    if (!p) return "";
                    var clean = p
                        .replace(/\\/g, "/")
                        .replace(/\/+$/, "");
                    var parts = clean.split("/");
                    if (parts.length >= 2)
                        return parts.slice(-2).join("/");
                    return parts[parts.length - 1] || "";
                }

                function escHtml(s) {
                    var d = document.createElement("div");
                    d.textContent = s;
                    return d.innerHTML;
                }

                function avatarColor(name) {
                    var colors = [
                        "#ff6b6b",
                        "#ffd93d",
                        "#6bcb77",
                        "#4d96ff",
                        "#ff922b",
                        "#845ef7",
                        "#20c997",
                        "#e64980",
                    ];
                    var hash = 0;
                    for (var i = 0; i < name.length; i++) {
                        hash =
                            name.charCodeAt(i) +
                            ((hash << 5) - hash);
                    }
                    return colors[Math.abs(hash) % colors.length];
                }

                function statusColor(s) {
                    if (s === "done") return "#00ff88";
                    if (s === "running") return "#ffcc00";
                    if (s === "failed") return "#ff3333";
                    return "rgba(255,255,255,0.25)";
                }

                // agent selection
                function selectAgent(name) {
                    state.selectedAgent = name;
                    state.taskFilter = "all";
                    state.contentJSON = "";

                    var cards =
                        document.querySelectorAll(".agent-card");
                    for (var i = 0; i < cards.length; i++) {
                        cards[i].classList.remove("active");
                    }
                    if (name) {
                        var el = document.getElementById(
                            "sb-agent-" + name,
                        );
                        if (el) el.classList.add("active");
                    }

                    txt(
                        document.getElementById("content-title"),
                        name || "overview",
                    );
                    txt(
                        document.getElementById("content-sub"),
                        name
                            ? shortPath(
                                  state.agentPaths[name] || "",
                              )
                            : "",
                    );

                    document.getElementById("cmd-agent").value =
                        name || "";
                    renderContent();
                }

                document
                    .getElementById("home-btn")
                    .addEventListener("click", function () {
                        selectAgent(null);
                    });

                // activity accordion
                document
                    .getElementById("activity-toggle")
                    .addEventListener("click", function () {
                        state.activityOpen = !state.activityOpen;
                        document
                            .getElementById("activity-toggle")
                            .classList.toggle(
                                "open",
                                state.activityOpen,
                            );
                        document
                            .getElementById("activity-body")
                            .classList.toggle(
                                "open",
                                state.activityOpen,
                            );
                    });

                // command bar mode
                function setMode(m) {
                    state.mode = m;
                    var taskBtn =
                        document.getElementById("mode-task");
                    var msgBtn =
                        document.getElementById("mode-msg");
                    var sendBtn =
                        document.getElementById("cmd-send");

                    taskBtn.className =
                        "cmdbar-mode-btn" +
                        (m === "task" ? " task-active" : "");
                    msgBtn.className =
                        "cmdbar-mode-btn" +
                        (m === "message" ? " msg-active" : "");
                    sendBtn.className =
                        "cmdbar-send " +
                        (m === "task" ? "task-mode" : "msg-mode");

                    document.getElementById(
                        "cmd-input",
                    ).placeholder =
                        m === "task"
                            ? "assign a task..."
                            : "send a message...";
                }

                document
                    .getElementById("mode-task")
                    .addEventListener("click", function () {
                        setMode("task");
                    });
                document
                    .getElementById("mode-msg")
                    .addEventListener("click", function () {
                        setMode("message");
                    });

                // polling
                function pollHealth() {
                    return get("/health").then(function (d) {
                        var dot = document.getElementById("hd");
                        if (d && d.status === "ok") {
                            dot.classList.add("on");
                        } else {
                            dot.classList.remove("on");
                        }
                    });
                }

                function pollAgents() {
                    return get("/agents").then(function (data) {
                        if (!data) return;
                        var j = JSON.stringify(data);
                        if (j === state.agentsJSON) return;
                        state.agentsJSON = j;
                        txt(
                            document.getElementById(
                                "agent-count",
                            ),
                            String(data.length),
                        );

                        state.agentNames = [];
                        state.agentPaths = {};
                        var list =
                            document.getElementById("agent-list");
                        list.innerHTML = "";

                        if (!data.length) {
                            var em = mk("div", "empty");
                            em.style.padding = "16px";
                            em.style.textAlign = "left";
                            em.style.fontSize = "0.65rem";
                            txt(em, "no agents online");
                            list.appendChild(em);
                            updateAgentSelect();
                            return;
                        }

                        for (var i = 0; i < data.length; i++) {
                            var a = data[i];
                            state.agentNames.push(a.name);
                            state.agentPaths[a.name] = a.path;

                            var card = mk("div", "agent-card");
                            card.id = "sb-agent-" + a.name;
                            if (state.selectedAgent === a.name) {
                                card.classList.add("active");
                            }

                            (function (agentName) {
                                card.addEventListener(
                                    "click",
                                    function () {
                                        selectAgent(agentName);
                                    },
                                );
                            })(a.name);

                            var dot = mk("div", "agent-dot");
                            dot.classList.add(
                                a.status === "active"
                                    ? "on"
                                    : "off",
                            );
                            card.appendChild(dot);

                            var info = mk("div", "agent-info");
                            var name = mk("div", "agent-name");
                            txt(name, a.name);
                            info.appendChild(name);

                            if (a.path) {
                                var path = mk(
                                    "div",
                                    "agent-path",
                                );
                                txt(path, shortPath(a.path));
                                info.appendChild(path);
                            }

                            card.appendChild(info);

                            if (a.mailbox_count > 0) {
                                var badge = mk(
                                    "span",
                                    "agent-badge",
                                );
                                txt(badge, a.mailbox_count);
                                card.appendChild(badge);
                            }

                            list.appendChild(card);
                        }
                        updateAgentSelect();
                    });
                }

                function updateAgentSelect() {
                    var sel =
                        document.getElementById("cmd-agent");
                    var cur = sel.value;
                    sel.innerHTML = "";
                    var def = mk("option");
                    def.value = "";
                    txt(def, "agent");
                    sel.appendChild(def);
                    for (
                        var i = 0;
                        i < state.agentNames.length;
                        i++
                    ) {
                        var opt = mk("option");
                        opt.value = state.agentNames[i];
                        txt(opt, state.agentNames[i]);
                        sel.appendChild(opt);
                    }
                    if (
                        cur &&
                        state.agentNames.indexOf(cur) >= 0
                    )
                        sel.value = cur;
                }

                function pollActivity() {
                    return get("/activity").then(function (data) {
                        if (!data) return;
                        var j = JSON.stringify(data);
                        if (j === state.activityJSON) return;
                        state.activityJSON = j;

                        txt(
                            document.getElementById(
                                "activity-count",
                            ),
                            String(data.length),
                        );

                        var list = document.getElementById(
                            "activity-list",
                        );
                        list.innerHTML = "";

                        for (
                            var i = data.length - 1;
                            i >= 0;
                            i--
                        ) {
                            var it = data[i];
                            var item = mk(
                                "div",
                                "activity-item",
                            );
                            var tag = mk(
                                "span",
                                "activity-tag",
                            );
                            var text = mk(
                                "span",
                                "activity-text",
                            );
                            var time = mk(
                                "span",
                                "activity-time",
                            );
                            txt(time, ago(it.timestamp));

                            if (it.event === "register") {
                                tag.classList.add("join");
                                txt(tag, "join");
                                txt(text, it.agent || "");
                            } else if (
                                it.event === "message"
                            ) {
                                tag.classList.add("msg");
                                txt(tag, "msg");
                                txt(
                                    text,
                                    (it.sender || "?") +
                                        " \u2192 " +
                                        (it.peer || "?"),
                                );
                            } else if (
                                it.event === "task_created"
                            ) {
                                tag.classList.add("task");
                                txt(tag, "task");
                                txt(
                                    text,
                                    (it.agent || "") +
                                        ": " +
                                        (it.description || ""),
                                );
                            } else if (
                                it.event === "task_updated"
                            ) {
                                tag.classList.add("update");
                                txt(tag, "upd");
                                txt(
                                    text,
                                    (it.task_id || "") +
                                        " \u2192 " +
                                        (it.status || ""),
                                );
                            } else {
                                txt(tag, it.event);
                            }

                            item.appendChild(tag);
                            item.appendChild(text);
                            item.appendChild(time);
                            list.appendChild(item);
                        }
                    });
                }

                // content rendering
                function renderContent() {
                    var agent = state.selectedAgent;

                    if (agent) {
                        Promise.all([
                            get("/peek/" + agent),
                            get("/tasks/" + agent),
                        ]).then(function (results) {
                            var peek = results[0] || {
                                count: 0,
                                messages: [],
                            };
                            var tasks = results[1] || [];
                            state.cachedTasks = tasks;
                            state.cachedPeek = peek;

                            var j = JSON.stringify([
                                peek,
                                tasks,
                                state.taskFilter,
                            ]);
                            if (j === state.contentJSON) return;
                            state.contentJSON = j;

                            renderAgentView(peek, tasks);
                        });
                    } else {
                        get("/tasks").then(function (tasks) {
                            tasks = tasks || [];
                            state.cachedTasks = tasks;

                            var j = JSON.stringify([
                                tasks,
                                state.taskFilter,
                            ]);
                            if (j === state.contentJSON) return;
                            state.contentJSON = j;

                            renderOverview(tasks);
                        });
                    }
                }

                function renderOverview(tasks) {
                    var area =
                        document.getElementById("content-area");
                    area.innerHTML = "";

                    // stats row
                    var counts = {
                        pending: 0,
                        running: 0,
                        done: 0,
                        failed: 0,
                    };
                    for (var i = 0; i < tasks.length; i++) {
                        var s = tasks[i].status;
                        if (counts[s] !== undefined)
                            counts[s]++;
                    }

                    var stats = mk("div", "stats-row");
                    addStat(
                        stats,
                        "on",
                        state.agentNames.length + " agents",
                    );
                    addSep(stats);
                    addStat(
                        stats,
                        "pending",
                        counts.pending + " pending",
                    );
                    addSep(stats);
                    addStat(
                        stats,
                        "running",
                        counts.running + " running",
                    );
                    addSep(stats);
                    addStat(
                        stats,
                        "done",
                        counts.done + " done",
                    );
                    if (counts.failed > 0) {
                        addSep(stats);
                        addStat(
                            stats,
                            "failed",
                            counts.failed + " failed",
                        );
                    }
                    area.appendChild(stats);

                    // section label
                    var label = mk("div", "section-label");
                    txt(label, "tasks (" + tasks.length + ")");
                    area.appendChild(label);

                    // filter tabs
                    var tabsEl = mk("div", "filter-tabs");
                    tabsEl.id = "filter-tabs";
                    renderFilterTabs(tasks, tabsEl);
                    area.appendChild(tabsEl);

                    // task list
                    var listEl = mk("div", "");
                    listEl.id = "task-list";
                    renderTaskList(tasks, listEl);
                    area.appendChild(listEl);
                }

                function renderAgentView(peek, tasks) {
                    var area =
                        document.getElementById("content-area");
                    area.innerHTML = "";

                    // messages section
                    var msgLabel = mk("div", "section-label");
                    txt(
                        msgLabel,
                        "messages (" + peek.count + ")",
                    );
                    area.appendChild(msgLabel);

                    if (
                        !peek.messages ||
                        !peek.messages.length
                    ) {
                        var em = mk("div", "empty");
                        em.innerHTML =
                            "no messages<br><span class='empty-hint'>agents will reply here</span>";
                        area.appendChild(em);
                    } else {
                        for (
                            var i = 0;
                            i < peek.messages.length;
                            i++
                        ) {
                            area.appendChild(
                                buildMsgCard(peek.messages[i]),
                            );
                        }
                    }

                    // tasks section
                    var section = mk("div", "tasks-section");
                    var label = mk("div", "section-label");
                    txt(label, "tasks (" + tasks.length + ")");
                    section.appendChild(label);

                    var tabsEl = mk("div", "filter-tabs");
                    tabsEl.id = "filter-tabs";
                    renderFilterTabs(tasks, tabsEl);
                    section.appendChild(tabsEl);

                    var listEl = mk("div", "");
                    listEl.id = "task-list";
                    renderTaskList(tasks, listEl);
                    section.appendChild(listEl);

                    area.appendChild(section);
                }

                function renderFilterTabs(tasks, container) {
                    var counts = {
                        all: tasks.length,
                        pending: 0,
                        running: 0,
                        done: 0,
                        failed: 0,
                    };
                    for (var i = 0; i < tasks.length; i++) {
                        var s = tasks[i].status;
                        if (counts[s] !== undefined)
                            counts[s]++;
                    }

                    container.innerHTML = "";
                    var filters = [
                        "all",
                        "pending",
                        "running",
                        "done",
                    ];
                    if (counts.failed > 0)
                        filters.push("failed");

                    for (var f = 0; f < filters.length; f++) {
                        var name = filters[f];
                        var btn = mk(
                            "button",
                            "filter-tab" +
                                (state.taskFilter === name
                                    ? " active"
                                    : ""),
                        );
                        txt(
                            btn,
                            name + " (" + counts[name] + ")",
                        );
                        (function (filterName) {
                            btn.addEventListener(
                                "click",
                                function () {
                                    state.taskFilter =
                                        filterName;
                                    state.contentJSON = "";
                                    var tabsEl =
                                        document.getElementById(
                                            "filter-tabs",
                                        );
                                    var listEl =
                                        document.getElementById(
                                            "task-list",
                                        );
                                    if (tabsEl && listEl) {
                                        renderFilterTabs(
                                            state.cachedTasks,
                                            tabsEl,
                                        );
                                        renderTaskList(
                                            state.cachedTasks,
                                            listEl,
                                        );
                                    }
                                },
                            );
                        })(name);
                        container.appendChild(btn);
                    }
                }

                function renderTaskList(tasks, container) {
                    container.innerHTML = "";
                    var filtered =
                        state.taskFilter === "all"
                            ? tasks
                            : tasks.filter(function (t) {
                                  return (
                                      t.status ===
                                      state.taskFilter
                                  );
                              });

                    if (!filtered.length) {
                        var em = mk("div", "empty");
                        if (state.taskFilter === "all") {
                            em.innerHTML =
                                "no tasks yet<br><span class='empty-hint'>select an agent and assign one below</span>";
                        } else {
                            txt(
                                em,
                                "no " +
                                    state.taskFilter +
                                    " tasks",
                            );
                        }
                        container.appendChild(em);
                        return;
                    }

                    for (
                        var i = 0;
                        i < filtered.length;
                        i++
                    ) {
                        container.appendChild(
                            buildTaskCard(filtered[i]),
                        );
                    }
                }

                function buildTaskCard(t) {
                    var card = mk("div", "task-card");
                    // status shown by dot + badge text only

                    // top row: status badge + task id
                    var top = mk("div", "task-top");
                    var badge = mk("span", "task-status-badge");
                    badge.style.color = statusColor(t.status);
                    var dot = mk(
                        "span",
                        "task-status-dot" +
                            (t.status === "running"
                                ? " running"
                                : ""),
                    );
                    dot.style.background = statusColor(t.status);
                    badge.appendChild(dot);
                    var statusText = document.createTextNode(
                        " " + t.status,
                    );
                    badge.appendChild(statusText);
                    top.appendChild(badge);

                    var tid = mk("span", "task-id");
                    txt(tid, t.id);
                    top.appendChild(tid);
                    card.appendChild(top);

                    // agent name
                    var agent = mk("div", "task-agent");
                    txt(agent, t.agent);
                    card.appendChild(agent);

                    // description
                    var desc = mk("div", "task-desc");
                    txt(desc, t.description);
                    card.appendChild(desc);

                    // result block
                    if (t.result) {
                        var res = mk(
                            "div",
                            "task-result-block",
                        );
                        txt(res, t.result);
                        card.appendChild(res);
                    }

                    // timestamp
                    var tm = mk("div", "task-time");
                    txt(tm, ago(t.created_at));
                    card.appendChild(tm);

                    return card;
                }

                function buildMsgCard(m) {
                    var card = mk("div", "msg-card");

                    // avatar
                    var senderName = m.from || "unknown";
                    var avatar = mk("div", "msg-avatar");
                    avatar.style.background =
                        avatarColor(senderName);
                    txt(avatar, senderName.charAt(0));
                    card.appendChild(avatar);

                    // content
                    var content = mk("div", "msg-content");

                    var header = mk("div", "msg-header");
                    var sender = mk("span", "msg-sender");
                    txt(sender, senderName);
                    header.appendChild(sender);
                    var time = mk("span", "msg-time");
                    txt(time, ago(m.timestamp));
                    header.appendChild(time);
                    content.appendChild(header);

                    var body = mk("div", "msg-body");
                    txt(body, m.message);
                    content.appendChild(body);

                    card.appendChild(content);
                    return card;
                }

                function addStat(parent, cls, text) {
                    var span = mk("span", "stat");
                    var dot = mk("span", "stat-dot " + cls);
                    span.appendChild(dot);
                    span.appendChild(
                        document.createTextNode(" " + text),
                    );
                    parent.appendChild(span);
                }

                function addSep(parent) {
                    var sep = mk("span", "stat-sep");
                    txt(sep, "\u00b7");
                    parent.appendChild(sep);
                }

                // send command
                function send() {
                    var sel =
                        document.getElementById("cmd-agent");
                    var inp =
                        document.getElementById("cmd-input");
                    var agent = sel.value;
                    var text = inp.value.trim();
                    if (!agent || !text) return;

                    if (state.mode === "task") {
                        fetch("/task", {
                            method: "POST",
                            headers: {
                                "Content-Type":
                                    "application/json",
                            },
                            body: JSON.stringify({
                                agent: agent,
                                description: text,
                            }),
                        })
                            .then(function () {
                                inp.value = "";
                                tick();
                            })
                            .catch(function () {});
                    } else {
                        fetch("/send", {
                            method: "POST",
                            headers: {
                                "Content-Type":
                                    "application/json",
                            },
                            body: JSON.stringify({
                                sender: "dashboard",
                                peer: agent,
                                message: text,
                            }),
                        })
                            .then(function () {
                                inp.value = "";
                                tick();
                            })
                            .catch(function () {});
                    }
                }

                document
                    .getElementById("cmd-send")
                    .addEventListener("click", send);
                document
                    .getElementById("cmd-input")
                    .addEventListener("keydown", function (e) {
                        if (e.key === "Enter") send();
                    });

                function tick() {
                    pollHealth();
                    pollAgents();
                    pollActivity();
                    renderContent();
                }

                // register dashboard as a peer so agents can message it
                fetch("/register", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        name: "dashboard",
                        path: "dashboard",
                    }),
                }).then(function () {
                    tick();
                });
                setInterval(tick, POLL);
            })();
        </script>
    </body>
</html>
